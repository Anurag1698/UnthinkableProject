<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E-commerce Product Recommender</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1>
          <i class="fas fa-shopping-cart"></i> E-commerce Product Recommender
        </h1>
        <p>AI-powered product recommendations with explanations</p>
        <div class="user-info-header">
          <span id="currentUserInfo">Shopping Assistant</span>
          <div class="header-actions">
            <button id="viewCartBtn" class="btn btn-sm btn-primary">
              <i class="fas fa-shopping-cart"></i> View Cart (<span
                id="cartCount"
                >0</span
              >)
            </button>
            <button id="viewViewsBtn" class="btn btn-sm btn-info">
              <i class="fas fa-eye"></i> View History (<span id="viewsCount"
                >0</span
              >)
            </button>
            <button id="viewOrdersBtn" class="btn btn-sm btn-secondary">
              <i class="fas fa-box"></i> View Orders
            </button>
          </div>
        </div>
      </header>

      <div class="user-section">
        <div class="user-selector">
          <button id="getRecommendations" class="btn btn-primary">
            <i class="fas fa-magic"></i> Get My Recommendations
          </button>
        </div>
      </div>

      <div
        class="recommendations-section"
        id="recommendationsSection"
        style="display: none"
      >
        <h2><i class="fas fa-star"></i> Your Personalized Recommendations</h2>
        <div id="recommendationsContainer"></div>
      </div>

      <div class="products-section">
        <h2><i class="fas fa-box"></i> Available Products</h2>
        <div id="productsContainer"></div>
      </div>

      <!-- Cart Modal -->
      <div id="cartModal" class="modal" style="display: none">
        <div class="modal-content">
          <div class="modal-header">
            <h2><i class="fas fa-shopping-cart"></i> Your Cart</h2>
            <span class="close">&times;</span>
          </div>
          <div class="modal-body">
            <div id="cartItems"></div>
            <div class="cart-total">
              <h3>Total: <span id="cartTotal">₹0.00</span></h3>
              <button id="checkoutBtn" class="btn btn-success">
                <i class="fas fa-credit-card"></i> Checkout
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Views Modal -->
      <div id="viewsModal" class="modal" style="display: none">
        <div class="modal-content">
          <div class="modal-header">
            <h2><i class="fas fa-eye"></i> Your View History</h2>
            <span class="close">&times;</span>
          </div>
          <div class="modal-body">
            <div id="viewsList"></div>
          </div>
        </div>
      </div>

      <!-- Orders Modal -->
      <div id="ordersModal" class="modal" style="display: none">
        <div class="modal-content">
          <div class="modal-header">
            <h2><i class="fas fa-box"></i> Your Orders</h2>
            <span class="close">&times;</span>
          </div>
          <div class="modal-body">
            <div id="ordersList"></div>
          </div>
        </div>
      </div>

      <div class="interaction-log" id="interactionLog" style="display: none">
        <h3><i class="fas fa-history"></i> Recent Interactions</h3>
        <div id="interactionHistory"></div>
      </div>
    </div>

    <script>
      let currentUser = 1; // Fixed user ID for single-user authentication
      let products = [];
      let userInteractions = [];
      let cartItems = [];
      let viewHistory = [];

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        loadProducts();
        loadCart();
        loadViews();
        setupEventListeners();
        updateUserInfo();
      });

      function setupEventListeners() {
        document
          .getElementById("getRecommendations")
          .addEventListener("click", getRecommendations);

        document
          .getElementById("viewCartBtn")
          .addEventListener("click", showCartModal);
        document
          .getElementById("viewViewsBtn")
          .addEventListener("click", showViewsModal);
        document
          .getElementById("viewOrdersBtn")
          .addEventListener("click", showOrdersModal);
        document
          .getElementById("checkoutBtn")
          .addEventListener("click", checkout);

        // Modal close functionality
        document.querySelectorAll(".close").forEach((closeBtn) => {
          closeBtn.addEventListener("click", function () {
            this.closest(".modal").style.display = "none";
          });
        });

        // Close modal when clicking outside
        window.addEventListener("click", function (event) {
          if (event.target.classList.contains("modal")) {
            event.target.style.display = "none";
          }
        });
      }

      function updateUserInfo() {
        // Keep the shopping assistant greeting
        document.getElementById("currentUserInfo").textContent =
          "Shopping Assistant";
      }

      async function loadProducts() {
        try {
          const response = await fetch("/api/products");
          products = await response.json();
          displayProducts();
        } catch (error) {
          console.error("Error loading products:", error);
          showNotification("Error loading products", "error");
        }
      }

      async function loadCart() {
        try {
          const response = await fetch(`/api/cart/${currentUser}`);
          const cartData = await response.json();
          cartItems = cartData.items || [];
          updateCartCount();
        } catch (error) {
          console.error("Error loading cart:", error);
        }
      }

      function updateCartCount() {
        const totalItems = cartItems.reduce(
          (sum, item) => sum + item.quantity,
          0
        );
        document.getElementById("cartCount").textContent = totalItems;
      }

      async function loadViews() {
        try {
          const response = await fetch(`/api/views/${currentUser}`);
          const viewsData = await response.json();
          viewHistory = viewsData.views || [];
          updateViewsCount();
        } catch (error) {
          console.error("Error loading views:", error);
        }
      }

      function updateViewsCount() {
        const uniqueViews = new Set(viewHistory.map((view) => view.product_id));
        document.getElementById("viewsCount").textContent = uniqueViews.size;
      }

      function displayProducts() {
        const container = document.getElementById("productsContainer");
        container.innerHTML = "";

        products.forEach((product) => {
          const productCard = createProductCard(product);
          container.appendChild(productCard);
        });
      }

      function createProductCard(product) {
        const card = document.createElement("div");
        card.className = "product-card";
        card.innerHTML = `
                <div class="product-image">
                    <img src="${product.image_url}" alt="${
          product.name
        }" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                </div>
                <div class="product-info">
                    <h3>${product.name}</h3>
                    <p class="product-description">${product.description}</p>
                    <div class="product-details">
                        <span class="category">${product.category}</span>
                        <span class="brand">${product.brand}</span>
                        <span class="rating">
                            <i class="fas fa-star"></i> ${product.rating}
                        </span>
                    </div>
                    <div class="product-price">₹${product.price.toLocaleString(
                      "en-IN",
                      { minimumFractionDigits: 2 }
                    )}</div>
                     <div class="product-actions">
                         <button class="btn btn-sm btn-secondary" onclick="logInteraction(${
                           product.id
                         }, 'view')">
                              <i class="fas fa-eye"></i> View
                          </button>
                         <button class="btn btn-sm btn-success" onclick="addToCart(${
                           product.id
                         })">
                              <i class="fas fa-shopping-cart"></i> Add to Cart
                          </button>
                      </div>
                </div>
            `;
        return card;
      }

      async function getRecommendations() {
        try {
          showNotification("Getting recommendations...", "info");
          const response = await fetch(`/api/recommend/${currentUser}`);
          const data = await response.json();

          if (data.error) {
            showNotification(data.error, "error");
            return;
          }

          displayRecommendations(data.recommendations);
          showNotification(
            `Found ${data.total_recommendations} recommendations!`,
            "success"
          );
        } catch (error) {
          console.error("Error getting recommendations:", error);
          showNotification("Error getting recommendations", "error");
        }
      }

      function displayRecommendations(recommendations) {
        const container = document.getElementById("recommendationsContainer");
        container.innerHTML = "";

        recommendations.forEach((rec, index) => {
          const recCard = document.createElement("div");
          recCard.className = "recommendation-card";
          recCard.innerHTML = `
                    <div class="rec-image">
                        <img src="${rec.product.image_url}" alt="${
            rec.product.name
          }" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                    </div>
                    <div class="rec-header">
                        <h3>${rec.product.name}</h3>
                        <span class="rec-type ${rec.recommendation_type}">${
            rec.recommendation_type
          }</span>
                    </div>
                    <div class="rec-content">
                        <div class="rec-product-info">
                            <p class="rec-description">${
                              rec.product.description
                            }</p>
                            <div class="rec-details">
                                <span class="category">${
                                  rec.product.category
                                }</span>
                                <span class="brand">${rec.product.brand}</span>
                                <span class="rating">
                                    <i class="fas fa-star"></i> ${
                                      rec.product.rating
                                    }
                                </span>
                            </div>
                            <div class="rec-price">₹${rec.product.price.toLocaleString(
                              "en-IN",
                              { minimumFractionDigits: 2 }
                            )}</div>
                        </div>
                        <div class="rec-explanation">
                            <h4><i class="fas fa-lightbulb"></i> Why this product?</h4>
                            <p>${rec.explanation}</p>
                        </div>
                    </div>
                     <div class="rec-actions">
                         <button class="btn btn-sm btn-secondary" onclick="logInteraction(${
                           rec.product.id
                         }, 'view')">
                              <i class="fas fa-eye"></i> View
                          </button>
                         <button class="btn btn-sm btn-success" onclick="addToCart(${
                           rec.product.id
                         })">
                              <i class="fas fa-shopping-cart"></i> Add to Cart
                          </button>
                      </div>
                `;
          container.appendChild(recCard);
        });

        document.getElementById("recommendationsSection").style.display =
          "block";
      }

      async function addToCart(productId) {
        try {
          const response = await fetch("/api/cart/add", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              user_id: currentUser,
              product_id: productId,
              quantity: 1,
            }),
          });

          const data = await response.json();

          if (data.error) {
            showNotification(data.error, "error");
          } else {
            showNotification("Item added to cart!", "success");
            loadCart(); // Refresh cart
          }
        } catch (error) {
          console.error("Error adding to cart:", error);
          showNotification("Error adding to cart", "error");
        }
      }

      async function logInteraction(productId, interactionType) {
        try {
          const response = await fetch("/api/interaction", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              user_id: currentUser,
              product_id: productId,
              interaction_type: interactionType,
            }),
          });

          const data = await response.json();

          if (data.error) {
            showNotification(data.error, "error");
          } else {
            showNotification(
              `Interaction logged: ${interactionType}`,
              "success"
            );
            // If it's a view interaction, update views
            if (interactionType === "view") {
              loadViews();
            }
          }
        } catch (error) {
          console.error("Error logging interaction:", error);
          showNotification("Error logging interaction", "error");
        }
      }

      async function showCartModal() {
        await loadCart();
        const modal = document.getElementById("cartModal");
        const cartItemsContainer = document.getElementById("cartItems");

        if (cartItems.length === 0) {
          cartItemsContainer.innerHTML = "<p>Your cart is empty</p>";
        } else {
          cartItemsContainer.innerHTML = "";
          let totalAmount = 0;

          cartItems.forEach((item) => {
            const itemDiv = document.createElement("div");
            itemDiv.className = "cart-item";
            const itemTotal = item.quantity * item.product.price;
            totalAmount += itemTotal;

            itemDiv.innerHTML = `
              <div class="cart-item-info">
                <h4>${item.product.name}</h4>
                <p>₹${item.product.price.toLocaleString("en-IN", {
                  minimumFractionDigits: 2,
                })} each</p>
              </div>
              <div class="cart-item-controls">
                <button onclick="updateCartQuantity(${item.product_id}, ${
              item.quantity - 1
            })" class="btn btn-sm btn-secondary">-</button>
                <span>${item.quantity}</span>
                <button onclick="updateCartQuantity(${item.product_id}, ${
              item.quantity + 1
            })" class="btn btn-sm btn-secondary">+</button>
                <button onclick="removeFromCart(${
                  item.product_id
                })" class="btn btn-sm btn-danger">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
              <div class="cart-item-total">
                ₹${itemTotal.toLocaleString("en-IN", {
                  minimumFractionDigits: 2,
                })}
              </div>
            `;
            cartItemsContainer.appendChild(itemDiv);
          });

          document.getElementById(
            "cartTotal"
          ).textContent = `₹${totalAmount.toLocaleString("en-IN", {
            minimumFractionDigits: 2,
          })}`;
        }

        modal.style.display = "block";
      }

      async function updateCartQuantity(productId, newQuantity) {
        try {
          const response = await fetch("/api/cart/update", {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              user_id: currentUser,
              product_id: productId,
              quantity: newQuantity,
            }),
          });

          const data = await response.json();

          if (data.error) {
            showNotification(data.error, "error");
          } else {
            showCartModal(); // Refresh cart display
            loadCart(); // Update cart count
          }
        } catch (error) {
          console.error("Error updating cart:", error);
          showNotification("Error updating cart", "error");
        }
      }

      async function removeFromCart(productId) {
        try {
          const response = await fetch("/api/cart/remove", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              user_id: currentUser,
              product_id: productId,
            }),
          });

          const data = await response.json();

          if (data.error) {
            showNotification(data.error, "error");
          } else {
            showNotification("Item removed from cart", "success");
            showCartModal(); // Refresh cart display
            loadCart(); // Update cart count
          }
        } catch (error) {
          console.error("Error removing from cart:", error);
          showNotification("Error removing from cart", "error");
        }
      }

      async function checkout() {
        try {
          const response = await fetch("/api/orders/create", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              user_id: currentUser,
            }),
          });

          const data = await response.json();

          if (data.error) {
            showNotification(data.error, "error");
          } else {
            showNotification(
              `Order placed successfully! Order ID: ${data.order_id}`,
              "success"
            );
            document.getElementById("cartModal").style.display = "none";
            loadCart(); // Update cart count
          }
        } catch (error) {
          console.error("Error during checkout:", error);
          showNotification("Error during checkout", "error");
        }
      }

      async function showOrdersModal() {
        const modal = document.getElementById("ordersModal");
        const ordersContainer = document.getElementById("ordersList");

        try {
          const response = await fetch(`/api/orders/${currentUser}`);
          const data = await response.json();

          if (data.error) {
            showNotification(data.error, "error");
            return;
          }

          if (data.orders.length === 0) {
            ordersContainer.innerHTML = "<p>You have no orders yet</p>";
          } else {
            ordersContainer.innerHTML = "";

            data.orders.forEach((orderData) => {
              const orderDiv = document.createElement("div");
              orderDiv.className = "order-item";

              orderDiv.innerHTML = `
                <div class="order-header">
                  <h4>Order #${orderData.order.order.id}</h4>
                  <span class="order-status">${
                    orderData.order.order.status
                  }</span>
                  <span class="order-date">${new Date(
                    orderData.order.order.created_at
                  ).toLocaleDateString()}</span>
                </div>
                <div class="order-items">
                  ${orderData.items
                    .map(
                      (item) => `
                    <div class="order-item-detail">
                      <span>${item.product.name}</span>
                      <span>Qty: ${item.quantity}</span>
                      <span>₹${item.price.toLocaleString("en-IN", {
                        minimumFractionDigits: 2,
                      })}</span>
                    </div>
                  `
                    )
                    .join("")}
                </div>
                <div class="order-total">
                  Total: ₹${orderData.order.order.total_amount.toLocaleString(
                    "en-IN",
                    { minimumFractionDigits: 2 }
                  )}
                </div>
              `;
              ordersContainer.appendChild(orderDiv);
            });
          }
        } catch (error) {
          console.error("Error loading orders:", error);
          showNotification("Error loading orders", "error");
        }

        modal.style.display = "block";
      }

      async function showViewsModal() {
        const modal = document.getElementById("viewsModal");
        const viewsContainer = document.getElementById("viewsList");

        try {
          await loadViews(); // Refresh views data

          if (viewHistory.length === 0) {
            viewsContainer.innerHTML =
              "<p>You haven't viewed any products yet</p>";
          } else {
            viewsContainer.innerHTML = "";

            // Group views by product and show unique products
            const uniqueViews = new Map();
            viewHistory.forEach((view) => {
              if (!uniqueViews.has(view.product_id)) {
                uniqueViews.set(view.product_id, view);
              }
            });

            uniqueViews.forEach((view) => {
              const viewDiv = document.createElement("div");
              viewDiv.className = "view-item";

              viewDiv.innerHTML = `
                <div class="view-item-info">
                  <h4>${view.product.name}</h4>
                  <p>${view.product.description}</p>
                  <div class="view-item-details">
                    <span class="category">${view.product.category}</span>
                    <span class="brand">${view.product.brand}</span>
                    <span class="rating">
                      <i class="fas fa-star"></i> ${view.product.rating}
                    </span>
                  </div>
                  <div class="view-item-price">₹${view.product.price.toLocaleString(
                    "en-IN",
                    {
                      minimumFractionDigits: 2,
                    }
                  )}</div>
                </div>
                <div class="view-item-actions">
                  <button onclick="addToCart(${
                    view.product_id
                  })" class="btn btn-sm btn-success">
                    <i class="fas fa-shopping-cart"></i> Add to Cart
                  </button>
                  <button onclick="removeFromViews(${
                    view.product_id
                  })" class="btn btn-sm btn-danger">
                    <i class="fas fa-trash"></i> Remove
                  </button>
                </div>
              `;
              viewsContainer.appendChild(viewDiv);
            });
          }
        } catch (error) {
          console.error("Error loading views:", error);
          showNotification("Error loading view history", "error");
        }

        modal.style.display = "block";
      }

      async function removeFromViews(productId) {
        try {
          const response = await fetch("/api/views/remove", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              user_id: currentUser,
              product_id: productId,
            }),
          });

          const data = await response.json();

          if (data.error) {
            showNotification(data.error, "error");
          } else {
            showNotification("Item removed from view history", "success");
            showViewsModal(); // Refresh views display
            loadViews(); // Update views count
          }
        } catch (error) {
          console.error("Error removing from views:", error);
          showNotification("Error removing from views", "error");
        }
      }

      function showNotification(message, type = "info") {
        // Create notification element
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.innerHTML = `
                <i class="fas fa-${
                  type === "success"
                    ? "check-circle"
                    : type === "error"
                    ? "exclamation-circle"
                    : type === "warning"
                    ? "exclamation-triangle"
                    : "info-circle"
                }"></i>
                ${message}
            `;

        // Add to page
        document.body.appendChild(notification);

        // Remove after 3 seconds
        setTimeout(() => {
          notification.remove();
        }, 3000);
      }
    </script>
  </body>
</html>
